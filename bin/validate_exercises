#!/usr/bin/env bash
#
# Validate if tests can run properly and the example implementation
# is passing the tests for each exercise

set -o errexit
set -o nounset

cd "$( dirname "${BASH_SOURCE[0]}" )/.."

declare -A exercises
while read -r exercise; do
    exercises["$exercise"]=1
done < <(
    jq -r '
        .exercises  as $exs
        | ["concept","practice"][]
        | . as $type
        | $exs[$type][]
        | "exercises/\($type)/\(.slug)"
    ' config.json
)

warnings=0
errors=0
shopt -s nullglob

warnings=()
errors=()
for exercise in exercises/{concept,practice}/*; do
    if [[ -v exercises[$exercise] ]]; then
        unset "exercises[$exercise]"
    else
        warnings+=("$exercise does not appear in config.json!")
    fi

    bin/validate_one_exercise "$exercise" || errors+=("$exercise")
    echo
done

for exercise in "${!exercises[@]}"; do
    warnings+=("$exercise is in config.json but does not exist in the repo!")
done

echo "Testing finished"

status=0
if (( ${#warnings[@]} > 0 )); then
    echo 'Warnings:' >&2
    printf '\t%s\n' "${warnings[@]}" >&2
    ((++status))
fi
if (( ${#errors[@]} > 0 )); then
    echo 'Errors:' >&2
    printf '\t%s\n' "${errors[@]}" >&2
    ((++status))
fi
exit "$status"
